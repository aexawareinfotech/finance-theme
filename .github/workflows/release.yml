name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm install

      - name: Create theme zip
        run: |
          # Clean up any existing files
          rm -rf ./finance-theme ./finance-theme.zip

          # Create the theme folder with exact name WordPress expects
          mkdir finance-theme

          # Copy theme files (excluding dev files)
          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='package.json' \
            --exclude='package-lock.json' \
            --exclude='bun.lock' \
            --exclude='.releaserc.json' \
            --exclude='finance-theme' \
            --exclude='finance-theme.zip' \
            --exclude='scripts' \
            ./ finance-theme/

          # Verify the folder exists and has content
          ls -la finance-theme/

          # Create ZIP with correct structure (finance-theme at root)
          zip -r finance-theme.zip finance-theme

          # Verify ZIP structure
          unzip -l finance-theme.zip | head -20

          # Cleanup the temp folder
          rm -rf finance-theme

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
